# Migration Guide: Calcium Tracker → My Nutrients (Multi-Nutrient)

## Overview

This migration process converts user data from the legacy **My Calcium Tracker** (single-nutrient) format to the new **My Nutrients** (multi-nutrient) format.

The migration is a **two-stage process**:
1. **ID Mapping** - Maps old sequential food IDs to new stable appIds
2. **Multi-Nutrient Transform** - Converts calcium-only data to multi-nutrient format

## Prerequisites - Required Files

Before starting the migration, ensure these files exist in the `migration/` folder:

### Input Files (Must Have)
1. **User's backup file** - Export from user's current app instance
   - Example: `calcium-tracker-backup-2025-12-18.json`
   - Location: Exported by user, copy to migration folder
   - Contains: Journal entries, custom foods, settings, favorites, hidden foods

2. **Production baseline database** - `prod-foodDatabaseData.js`
   - Location: `migration/prod-foodDatabaseData.js`
   - Purpose: Snapshot of database from user's current production deployment
   - Size: ~657KB
   - Used to map old IDs to food names before matching to new database

3. **Current database** - `../src/lib/data/foodDatabaseData.js`
   - Location: `src/lib/data/foodDatabaseData.js`
   - Purpose: New multi-nutrient database with stable appIds
   - Size: ~3.3MB
   - Generated by data pipeline with keep list and salt preference

### Migration Scripts (Already Present)
- `migrate-backup-enhanced.mjs` - Stage 1: ID mapping
- `migrate_to_nutrients.mjs` - Stage 2: Multi-nutrient transform

### Optional Override Files
- `food-id-overrides.json` - Manual food ID mappings for edge cases
- `food-replacements-mapping.json` - Substitute foods for discontinued items

## Migration Workflow

### Step 0: Pre-Migration Merge (Optional - When Needed)

**When to use this step:**
- You have multiple backup files with different date ranges that need to be combined
- One backup has missing/corrupted data that was restored from an earlier backup
- You need to merge historical data with current data before migration

**Skip this step if:**
- You have a single, complete backup file to migrate
- All your data is already in one file

**What it does:**
- Merges journal entries from both files (union of all dates)
- Deduplicates custom foods by name (newer version wins on conflicts)
- Uses latest file's settings, favorites, serving preferences
- Creates single complete backup ready for migration

**Script:** `migration/merge_backups.py`

**Command:**
```bash
cd migration

python3 merge_backups.py \
  calcium-tracker-backup-OLD-with-missing-data.json \
  calcium-tracker-backup-CURRENT.json \
  calcium-tracker-MERGED.json
```

**Arguments:**
- First argument: Base/older backup file (e.g., file with restored missing dates)
- Second argument: Latest backup file (has current preferences and favorites)
- Third argument: Output merged file path

**Example Use Case:**
```bash
# Your wife's app is missing Aug 16-19 data
# You have an old backup (11-10) that HAS those dates
# You have a current backup (11-19) that's missing those dates but has current data

python3 merge_backups.py \
  calcium-tracker-backup-2025-11-10-updated-with-missing-data.json \
  calcium-tracker-backup-2025-11-19.json \
  calcium-tracker-backup-2025-11-19-merged.json

# Result: merged file has ALL dates (including Aug 16-19) plus current preferences
# Now use this merged file for Step 1 (ID Mapping)
```

**Output:**
- Creates merged backup file combining data from both sources
- Shows detailed merge report (what was added, deduplicated, preserved)
- Displays date range coverage

**Validation:**
```bash
# Quick check of merged file
python3 -c "
import json
data = json.load(open('calcium-tracker-MERGED.json'))
dates = sorted(data['journalEntries'].keys())
print(f'Total days: {len(dates)}')
print(f'Date range: {dates[0]} to {dates[-1]}')
print(f'Custom foods: {len(data[\"customFoods\"])}')
print(f'Check for missing dates in range...')
"
```

**After merging, proceed with normal migration workflow starting at Step 1.**

---

### Step 1: ID Mapping (Assign Stable appIds)

**What it does:**
- Loads old backup with sequential IDs (1, 2, 3, ...)
- Matches old IDs → food names (using prod baseline)
- Matches food names → new stable appIds (using current database)
- Preserves serving preferences by matching measure indices
- Generates merged backup with new appIds

**Command:**
```bash
cd migration

node migrate-backup-enhanced.mjs \
  --old-backup [user-backup].json \
  --old-database prod-foodDatabaseData.js \
  --curated-data ../src/lib/data/foodDatabaseData.js \
  --output merged-output.json
```

**Arguments:**
- `--old-backup` - User's exported backup file
- `--old-database` - Production baseline (maps old IDs to names)
- `--curated-data` - Current database (maps names to new appIds)
- `--output` - Merged output file with new appIds

**Output Files Created:**
- `merged-output.json` - Backup with old IDs replaced by new appIds (~240KB)
- `merged-output-migration-report.json` - Match quality report

**Validation:**
- Check migration report for match quality
- Look for "EXACT" and "HIGH" confidence matches
- Note any "UNMATCHED" items (will be dropped or substituted)

### Step 2: Multi-Nutrient Transform

**What it does:**
- Loads merged backup (with new appIds)
- Expands calcium-only values to multi-nutrient format
- Scales all nutrient values based on serving quantity
- Preserves all metadata (settings, preferences, favorites, hidden)
- Generates final restore file ready for import

**Command:**
```bash
node migrate_to_nutrients.mjs \
  --merged-backup merged-output.json \
  --new-database ../src/lib/data/foodDatabaseData.js \
  --output nutrients-restore-PRODUCTION.json
```

**Arguments:**
- `--merged-backup` - Output from Step 1
- `--new-database` - Current database (for nutrient lookups)
- `--output` - Final restore file for user

**Output Files Created:**
- `nutrients-restore-PRODUCTION.json` - Final migrated backup (~400-500KB)
- Migration summary in console output

**Validation:**
```bash
# Quick validation check
node -e "
  const fs = require('fs');
  const data = JSON.parse(fs.readFileSync('nutrients-restore-PRODUCTION.json'));
  console.log('Days:', Object.keys(data.journalEntries).length);
  console.log('Total Entries:', Object.values(data.journalEntries).flat().length);
  console.log('Custom Foods:', data.customFoods.length);
  console.log('Settings:', !!data.settings);
  console.log('Preferences:', !!data.preferences);
  console.log('Hidden Foods:', data.hiddenFoodIds ? data.hiddenFoodIds.length : 0);
"
```

**Expected output:**
- Days: ~145 (or user's actual day count)
- Total Entries: ~1,148 (or user's actual entry count)
- Custom Foods: ~66 (or user's actual custom food count)
- Settings: true
- Preferences: true
- Hidden Foods: 0-50 (varies by user)

### Step 3: User Import

**Instructions for user:**
1. Open My Nutrients app (new multi-nutrient version)
2. Go to Settings → Import/Export
3. Click "Import Data"
4. Select `nutrients-restore-PRODUCTION.json`
5. Confirm import
6. Verify data loaded correctly

## Data Structure Changes

### Legacy Format (Calcium-Only)
```json
{
  "journalEntries": {
    "2025-01-15": [
      {
        "foodId": 1258,
        "quantity": 2,
        "calcium": 276
      }
    ]
  }
}
```

### New Format (Multi-Nutrient)
```json
{
  "journalEntries": {
    "2025-01-15": [
      {
        "id": "abc-123",
        "foodId": 13562,
        "quantity": 2,
        "nutrients": {
          "protein": 15.98,
          "calcium": 552,
          "fiber": 0,
          "vitaminD": 5.8
        }
      }
    ]
  }
}
```

**Key Changes:**
- Sequential IDs (1, 2, 3) → Stable appIds (10001, 13562, etc.)
- Single `calcium` field → `nutrients` object with 20+ nutrients
- Added `id` field (UUID) to each journal entry
- Preserved quantity, measure index, custom food flag

## Troubleshooting

### "Error: Missing required arguments" (merge_backups.py)
- Ensure all 3 arguments are provided: base-file, latest-file, output-file
- Check file paths are correct and files exist

### "Error: Missing required arguments" (migrate-backup-enhanced.mjs)
- Ensure all 4 arguments are provided to migrate-backup-enhanced.mjs
- Use named argument format (--old-backup, --old-database, etc.)

### "Error: Cannot find module"
- Run from migration folder: `cd migration`
- Verify Node.js is installed: `node --version` (need v14+)
- Verify Python 3 is installed: `python3 --version` (for merge script)

### Missing dates in migrated data
- Check if you need Step 0 (Pre-Migration Merge) to combine multiple backups
- Review source backup file(s) to confirm all expected dates are present
- Use merge_backups.py to combine files before running migration scripts

### High unmatched food count
- Check prod-foodDatabaseData.js exists and is correct baseline
- Review unmatched foods in migration report
- Add manual mappings to food-id-overrides.json if needed

### Nutrient values seem wrong
- Verify serving quantity preserved correctly
- Check migration report for measure index matching
- Compare sample entries between old and new backup

### Missing custom foods
- Custom foods should transfer automatically
- Check nutrients-restore-PRODUCTION.json has customFoods array
- Verify custom food IDs start with "custom-"

## Files Reference

### Keep These Files (Required)
- `prod-foodDatabaseData.js` - Production baseline (657KB)
- `merge_backups.py` - Pre-migration merge script (optional, for combining backups)
- `migrate-backup-enhanced.mjs` - Stage 1 script (ID mapping)
- `migrate_to_nutrients.mjs` - Stage 2 script (multi-nutrient transform)
- `calcium-tracker-backup-2025-12-18.json` - Test backup (241KB)
- `food-id-overrides.json` - Manual mappings (7.5KB)
- Migration documentation files (*.md)

### Generated Files (Can Delete After Import)
- `merged-output.json` - Intermediate file from Stage 1
- `merged-output-migration-report.json` - Stage 1 report
- `nutrients-restore-PRODUCTION.json` - Final output (give to user, then can delete)

### Test Files (Already Cleaned Up)
- Test migration outputs removed in commit f8a4f13
- Only production migration files remain

## Migration History

- **2025-11-10** - Initial migration tests
- **2025-11-19** - Enhanced measure matching, pre-migration merge for missing Aug dates
- **2025-12-18** - Final test run with all 8 fixes applied
- **2025-12-23** - Documentation updated, ready for production
- **2025-12-24** - Added Step 0 (Pre-Migration Merge) documentation, updated merge_backups.py with CLI args

See `MIGRATION-CORRECTED-2025-12-18.md` for complete migration log with all fixes applied.

## Success Criteria

✅ All journal entries migrated (145 days, 1,148 entries expected)
✅ All custom foods preserved (66 expected)
✅ Settings and preferences intact
✅ Serving preferences maintained (measure index matching)
✅ Nutrient values scaled correctly by quantity
✅ Hidden foods and favorites transferred
✅ No errors in migration output
✅ User can import and use the app normally

---

**Last Updated:** December 24, 2025
**Migration Scripts Version:** Enhanced with measure index matching and pre-migration merge
**Ready for Production:** Yes
